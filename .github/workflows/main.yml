name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure Core RDP Settings
        run: |
          # Enable Remote Desktop and disable Network Level Authentication (if needed)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "SecurityLayer" -Value 0 -Force

          # Remove any existing rule with the same name to avoid duplication
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          
          # For testing, allow any incoming connection on port 3389
          netsh advfirewall firewall add rule name="RDP-Tailscale" `
            dir=in action=allow protocol=TCP localport=3389

          # (Optional) Restart the Remote Desktop service to ensure changes take effect
          Restart-Service -Name TermService -Force

      - name: Create RDP User
        run: |
          Write-Host "Creating RDP user..."
          
          # FIRST, disable password complexity using a simple command
          net accounts /MINPWLEN:1
          
          # Use a password that definitely meets requirements
          $password = "P@ssw0rd123!"
          
          # Create user using cmd.exe to avoid PowerShell restrictions
          cmd.exe /c "net user MICKEY $password /add /Y /expires:never"
          cmd.exe /c "net localgroup administrators MICKEY /add"
          cmd.exe /c "net localgroup `"Remote Desktop Users`" MICKEY /add"
          
          # Verify the user was created
          $userCheck = cmd.exe /c "net user MICKEY"
          if ($userCheck -like "*User name*MICKEY*") {
              echo "RDP_CREDS=User: MICKEY | Password: $password" >> $env:GITHUB_ENV
              Write-Host "✓ User created successfully!"
              Write-Host "Username: MICKEY"
              Write-Host "Password: $password"
          } else {
              Write-Error "User creation failed"
              exit 1
          }

      - name: Install Tailscale
        run: |
          Write-Host "Installing Tailscale..."
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force
          Write-Host "Tailscale installed successfully"

      - name: Install Automa Chrome Extension
        run: |
          Write-Host "Installing Automa Chrome extension..."
          
          # Create batch file content as an array of lines
          $batchLines = @(
            '@echo off',
            'echo ============================================',
            'echo AUTOMA CHROME EXTENSION INSTALLATION',
            'echo ============================================',
            'echo.',
            'echo Please follow these steps:',
            'echo.',
            'echo 1. Open Google Chrome',
            'echo 2. Visit this URL: ',
            'echo    https://chrome.google.com/webstore/detail/automa/infppggnoaenmfagbfknfkancpbljcca',
            'echo 3. Click "Add to Chrome" button',
            'echo 4. Confirm the installation',
            'echo.',
            'echo The extension will appear in your Chrome toolbar!',
            'echo.',
            'echo Note: This must be done manually due to Chrome security policies.',
            'echo.',
            'pause'
          )
          
          # Save batch file to desktop
          $batchPath = "C:\Users\Public\Desktop\Install_Automa.bat"
          $batchLines -join "`r`n" | Out-File -FilePath $batchPath -Encoding ASCII
          
          # Create text file content as an array of lines
          $textLines = @(
            'AUTOMA CHROME EXTENSION - INSTALLATION GUIDE',
            '=============================================',
            '',
            'STEP-BY-STEP INSTRUCTIONS:',
            '',
            '1. Open Google Chrome',
            '2. Go to this URL:',
            '   https://chrome.google.com/webstore/detail/automa/infppggnoaenmfagbfknfkancpbljcca',
            '',
            '3. Click the BLUE "Add to Chrome" button',
            '4. Click "Add extension" in the confirmation popup',
            '5. Wait for installation to complete',
            '6. The Automa icon will appear in Chrome toolbar (top-right)',
            '',
            'QUICK INSTALL:',
            '- Double-click "Install_Automa.bat" on desktop',
            '- Follow the instructions',
            '- Or just visit the URL above directly in Chrome',
            '',
            'NOTE: Chrome extensions require manual installation for security reasons.',
            'This takes less than 1 minute to complete!'
          )
          
          # Save text file to desktop
          $textPath = "C:\Users\Public\Desktop\Automa_Instructions.txt"
          $textLines -join "`r`n" | Out-File -FilePath $textPath -Encoding UTF8
          
          # Create URL shortcut content
          $urlLines = @(
            '[InternetShortcut]',
            'URL=https://chrome.google.com/webstore/detail/automa/infppggnoaenmfagbfknfkancpbljcca'
          )
          
          $urlPath = "C:\Users\Public\Desktop\Install Automa.url"
          $urlLines -join "`r`n" | Out-File -FilePath $urlPath -Encoding ASCII
          
          Write-Host "✓ Created installation files on desktop:"
          Write-Host "  - Install_Automa.bat (run this)"
          Write-Host "  - Automa_Instructions.txt"
          Write-Host "  - Install Automa.url (direct link)"

      - name: Create Instagram Auto Account Creator
        run: |
          Write-Host "Creating Instagram account automation script..."
          
          # Create the batch file using simple echo commands
          $batchLines = @(
            '@echo off',
            'echo ============================================',
            'echo INSTAGRAM ACCOUNT CREATION TOOL',
            'echo ============================================',
            'echo.',
            'echo This tool will:',
            'echo 1. Open Instagram signup page',
            'echo 2. Open temporary email services',
            'echo 3. Generate random account credentials',
            'echo.',
            'echo Press any key to start...',
            'pause >nul',
            '',
            'REM Generate random number for username',
            'set /a rand=%random%',
            'set username=InstaUser%rand%',
            '',
            'REM Generate password',
            'set password=Pass%rand%!@#',
            '',
            'REM Open Instagram signup page',
            'start chrome --new-window "https://www.instagram.com/accounts/emailsignup/"',
            '',
            'REM Open temporary email services',
            'timeout /t 2 /nobreak >nul',
            'start chrome --new-tab "https://temp-mail.org/"',
            'timeout /t 2 /nobreak >nul',
            'start chrome --new-tab "https://10minutemail.com/"',
            '',
            'echo.',
            'echo ============================================',
            'echo GENERATED CREDENTIALS:',
            'echo ============================================',
            'echo Username: %username%',
            'echo Password: %password%',
            'echo Email: Use temporary email from opened tabs',
            'echo.',
            'echo STEPS TO CREATE ACCOUNT:',
            'echo 1. Use username: %username%',
            'echo 2. Use password: %password%',
            'echo 3. Copy email from temp-mail.org',
            'echo 4. Complete Instagram signup form',
            'echo 5. Check temp email for verification code',
            'echo 6. Enter verification code on Instagram',
            'echo.',
            'echo Press any key to exit...',
            'pause >nul'
          )
          
          # Save batch file
          $batchPath = "C:\Users\Public\Desktop\Instagram_Account_Creator.bat"
          $batchLines -join "`r`n" | Out-File -FilePath $batchPath -Encoding ASCII
          
          # Create a simple text guide
          $guideLines = @(
            'INSTAGRAM ACCOUNT CREATION AUTOMATION GUIDE',
            '============================================',
            '',
            'QUICK START:',
            '1. Double-click "Instagram_Account_Creator.bat" on desktop',
            '2. Press any key when prompted',
            '3. Chrome will open with:',
            '   - Instagram signup page',
            '   - Temp email service 1',
            '   - Temp email service 2',
            '',
            'GENERATED CREDENTIALS:',
            '- Random username (e.g., InstaUser12345)',
            '- Strong password',
            '- Use temporary email from opened tabs',
            '',
            'STEPS TO CREATE ACCOUNT:',
            '1. On Instagram page, enter the generated username',
            '2. Enter the generated password',
            '3. Go to temp-mail.org and copy the email address',
            '4. Paste email in Instagram form',
            '5. Complete other details (name, birthday)',
            '6. Check temp email for verification code',
            '7. Enter code on Instagram',
            '8. Account created!',
            '',
            'TIPS:',
            '- Use different usernames each time',
            '- Clear browser cookies between accounts',
            '- Use VPN for multiple accounts',
            '- Instagram may limit 3-5 accounts per day per IP'
          )
          
          # Save guide
          $guidePath = "C:\Users\Public\Desktop\Instagram_Guide.txt"
          $guideLines -join "`r`n" | Out-File -FilePath $guidePath -Encoding UTF8
          
          Write-Host "✓ Created Instagram automation tools on desktop:"
          Write-Host "  - Instagram_Account_Creator.bat (main tool)"
          Write-Host "  - Instagram_Guide.txt (instructions)"

      - name: Establish Tailscale Connection
        run: |
          Write-Host "Setting up Tailscale connection..."
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID
          
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 10) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              if (-not $tsIP) {
                  Write-Host "Waiting for Tailscale IP... (attempt $retries)"
                  Start-Sleep -Seconds 5
                  $retries++
              }
          }
          
          if (-not $tsIP) {
              Write-Error "Tailscale IP not assigned. Exiting."
              exit 1
          }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "Tailscale IP: $tsIP"

      - name: Verify RDP Accessibility
        run: |
          Write-Host "Verifying RDP connectivity..."
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue
          if (-not $testResult.TcpTestSucceeded) {
              Write-Error "TCP connection to RDP port 3389 failed"
              exit 1
          }
          Write-Host "TCP connectivity successful!"

      - name: Maintain Connection
        run: |
          Write-Host "`n=== RDP ACCESS INFORMATION ==="
          Write-Host "Address: $env:TAILSCALE_IP"
          Write-Host "Username: MICKEY"
          Write-Host "Password: $(echo $env:RDP_CREDS)"
          Write-Host "===============================`n"
          
          Write-Host "TOOLS AVAILABLE ON DESKTOP:"
          Write-Host "============================="
          Write-Host "1. AUTOMA EXTENSION:"
          Write-Host "   - Install_Automa.bat"
          Write-Host "   - Install Automa.url"
          Write-Host "   - Automa_Instructions.txt"
          Write-Host ""
          Write-Host "2. INSTAGRAM ACCOUNT CREATOR:"
          Write-Host "   - Instagram_Account_Creator.bat (double-click this)"
          Write-Host "   - Instagram_Guide.txt"
          Write-Host ""
          Write-Host "USAGE:"
          Write-Host "- Double-click Instagram_Account_Creator.bat"
          Write-Host "- It opens Chrome with all needed pages"
          Write-Host "- Generates random credentials automatically"
          
          # Keep runner active indefinitely (or until manually cancelled)
          while ($true) {
              Write-Host "[$(Get-Date)] RDP Active - Use Ctrl+C in workflow to terminate"
              Start-Sleep -Seconds 300
          }
