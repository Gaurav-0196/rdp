name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure Core RDP Settings
        run: |
          # Enable Remote Desktop and disable Network Level Authentication (if needed)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "SecurityLayer" -Value 0 -Force

          # Remove any existing rule with the same name to avoid duplication
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          
          # For testing, allow any incoming connection on port 3389
          netsh advfirewall firewall add rule name="RDP-Tailscale" `
            dir=in action=allow protocol=TCP localport=3389

          # (Optional) Restart the Remote Desktop service to ensure changes take effect
          Restart-Service -Name TermService -Force

      - name: Create RDP User
        run: |
          Write-Host "Creating RDP user..."
          
          # FIRST, disable password complexity using a simple command
          net accounts /MINPWLEN:1
          
          # Use a password that definitely meets requirements
          $password = "P@ssw0rd123!"
          
          # Create user using cmd.exe to avoid PowerShell restrictions
          cmd.exe /c "net user MICKEY $password /add /Y /expires:never"
          cmd.exe /c "net localgroup administrators MICKEY /add"
          cmd.exe /c "net localgroup `"Remote Desktop Users`" MICKEY /add"
          
          # Verify the user was created
          $userCheck = cmd.exe /c "net user MICKEY"
          if ($userCheck -like "*User name*MICKEY*") {
              echo "RDP_CREDS=User: MICKEY | Password: $password" >> $env:GITHUB_ENV
              Write-Host "✓ User created successfully!"
              Write-Host "Username: MICKEY"
              Write-Host "Password: $password"
          } else {
              Write-Error "User creation failed"
              exit 1
          }

      - name: Install Tailscale
        run: |
          Write-Host "Installing Tailscale..."
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force
          Write-Host "Tailscale installed successfully"

      - name: Install Automa Chrome Extension
        run: |
          Write-Host "Installing Automa Chrome extension..."
          
          # Create batch file content as an array of lines
          $batchLines = @(
            '@echo off',
            'echo ============================================',
            'echo AUTOMA CHROME EXTENSION INSTALLATION',
            'echo ============================================',
            'echo.',
            'echo Please follow these steps:',
            'echo.',
            'echo 1. Open Google Chrome',
            'echo 2. Visit this URL: ',
            'echo    https://chrome.google.com/webstore/detail/automa/infppggnoaenmfagbfknfkancpbljcca',
            'echo 3. Click "Add to Chrome" button',
            'echo 4. Confirm the installation',
            'echo.',
            'echo The extension will appear in your Chrome toolbar!',
            'echo.',
            'echo Note: This must be done manually due to Chrome security policies.',
            'echo.',
            'pause'
          )
          
          # Save batch file to desktop
          $batchPath = "C:\Users\Public\Desktop\Install_Automa.bat"
          $batchLines -join "`r`n" | Out-File -FilePath $batchPath -Encoding ASCII
          
          # Create text file content as an array of lines
          $textLines = @(
            'AUTOMA CHROME EXTENSION - INSTALLATION GUIDE',
            '=============================================',
            '',
            'STEP-BY-STEP INSTRUCTIONS:',
            '',
            '1. Open Google Chrome',
            '2. Go to this URL:',
            '   https://chrome.google.com/webstore/detail/automa/infppggnoaenmfagbfknfkancpbljcca',
            '',
            '3. Click the BLUE "Add to Chrome" button',
            '4. Click "Add extension" in the confirmation popup',
            '5. Wait for installation to complete',
            '6. The Automa icon will appear in Chrome toolbar (top-right)',
            '',
            'QUICK INSTALL:',
            '- Double-click "Install_Automa.bat" on desktop',
            '- Follow the instructions',
            '- Or just visit the URL above directly in Chrome',
            '',
            'NOTE: Chrome extensions require manual installation for security reasons.',
            'This takes less than 1 minute to complete!'
          )
          
          # Save text file to desktop
          $textPath = "C:\Users\Public\Desktop\Automa_Instructions.txt"
          $textLines -join "`r`n" | Out-File -FilePath $textPath -Encoding UTF8
          
          # Create URL shortcut content
          $urlLines = @(
            '[InternetShortcut]',
            'URL=https://chrome.google.com/webstore/detail/automa/infppggnoaenmfagbfknfkancpbljcca'
          )
          
          $urlPath = "C:\Users\Public\Desktop\Install Automa.url"
          $urlLines -join "`r`n" | Out-File -FilePath $urlPath -Encoding ASCII
          
          Write-Host "✓ Created installation files on desktop:"
          Write-Host "  - Install_Automa.bat (run this)"
          Write-Host "  - Automa_Instructions.txt"
          Write-Host "  - Install Automa.url (direct link)"

      - name: Establish Tailscale Connection
        run: |
          Write-Host "Setting up Tailscale connection..."
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID
          
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 10) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              if (-not $tsIP) {
                  Write-Host "Waiting for Tailscale IP... (attempt $retries)"
                  Start-Sleep -Seconds 5
                  $retries++
              }
          }
          
          if (-not $tsIP) {
              Write-Error "Tailscale IP not assigned. Exiting."
              exit 1
          }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "Tailscale IP: $tsIP"

      - name: Verify RDP Accessibility
        run: |
          Write-Host "Verifying RDP connectivity..."
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue
          if (-not $testResult.TcpTestSucceeded) {
              Write-Error "TCP connection to RDP port 3389 failed"
              exit 1
          }
          Write-Host "TCP connectivity successful!"

      - name: Maintain Connection
        run: |
          Write-Host "`n=== RDP ACCESS INFORMATION ==="
          Write-Host "Address: $env:TAILSCALE_IP"
          Write-Host "Username: MICKEY"
          Write-Host "Password: $(echo $env:RDP_CREDS)"
          Write-Host "===============================`n"
          
          Write-Host "AUTOMA EXTENSION INSTALLATION:"
          Write-Host "==============================="
          Write-Host "After RDP login, you will find on desktop:"
          Write-Host "1. 'Install_Automa.bat' - Run this file"
          Write-Host "2. 'Install Automa.url' - Direct Chrome Web Store link"
          Write-Host "3. 'Automa_Instructions.txt' - Step-by-step guide"
          Write-Host ""
          Write-Host "Installation takes 1 minute:"
          Write-Host "- Click the URL shortcut"
          Write-Host "- Click 'Add to Chrome'"
          Write-Host "- Confirm installation"
          Write-Host ""
          
          # Keep runner active indefinitely (or until manually cancelled)
          while ($true) {
              Write-Host "[$(Get-Date)] RDP Active - Use Ctrl+C in workflow to terminate"
              Start-Sleep -Seconds 300
          }
