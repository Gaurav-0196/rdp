name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure Core RDP Settings
        run: |
          # Enable Remote Desktop and disable Network Level Authentication (if needed)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "SecurityLayer" -Value 0 -Force

          # Remove any existing rule with the same name to avoid duplication
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          
          # For testing, allow any incoming connection on port 3389
          netsh advfirewall firewall add rule name="RDP-Tailscale" `
            dir=in action=allow protocol=TCP localport=3389

          # (Optional) Restart the Remote Desktop service to ensure changes take effect
          Restart-Service -Name TermService -Force

      - name: Create RDP User
        run: |
          Write-Host "Creating RDP user..."
          
          # FIRST, disable password complexity using a simple command
          net accounts /MINPWLEN:1
          
          # Use a password that definitely meets requirements
          $password = "P@ssw0rd123!"
          
          # Create user using cmd.exe to avoid PowerShell restrictions
          cmd.exe /c "net user MICKEY $password /add /Y /expires:never"
          cmd.exe /c "net localgroup administrators MICKEY /add"
          cmd.exe /c "net localgroup `"Remote Desktop Users`" MICKEY /add"
          
          # Verify the user was created
          $userCheck = cmd.exe /c "net user MICKEY"
          if ($userCheck -like "*User name*MICKEY*") {
              echo "RDP_CREDS=User: MICKEY | Password: $password" >> $env:GITHUB_ENV
              Write-Host "✓ User created successfully!"
              Write-Host "Username: MICKEY"
              Write-Host "Password: $password"
          } else {
              Write-Error "User creation failed"
              exit 1
          }

      - name: Install Tailscale
        run: |
          Write-Host "Installing Tailscale..."
          
          # Download Tailscale installer
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          try {
              Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -TimeoutSec 60
              Write-Host "Tailscale installer downloaded"
          } catch {
              Write-Host "Failed to download, trying alternative URL..."
              $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
              Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -TimeoutSec 60
          }
          
          # Install Tailscale silently
          Write-Host "Installing Tailscale (this may take a minute)..."
          $installResult = Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait -PassThru
          
          if ($installResult.ExitCode -eq 0 -or $installResult.ExitCode -eq 3010) {
              Write-Host "✓ Tailscale installed successfully (Exit code: $($installResult.ExitCode))"
          } else {
              Write-Host "⚠ Tailscale installation warning (Exit code: $($installResult.ExitCode)) - continuing anyway"
          }
          
          # Clean up installer
          Remove-Item $installerPath -Force -ErrorAction SilentlyContinue
          
          # Give Tailscale service time to start
          Write-Host "Waiting for Tailscale service to start..."
          Start-Sleep -Seconds 10

      - name: Establish Tailscale Connection
        run: |
          Write-Host "Setting up Tailscale connection..."
          
          # Check if Tailscale is installed
          $tailscalePath = "${env:ProgramFiles}\Tailscale\tailscale.exe"
          if (-not (Test-Path $tailscalePath)) {
              Write-Host "Tailscale not found at $tailscalePath"
              Write-Host "Checking alternative location..."
              $tailscalePath = "${env:ProgramFiles(x86)}\Tailscale\tailscale.exe"
          }
          
          if (-not (Test-Path $tailscalePath)) {
              Write-Error "Tailscale not installed. Exiting."
              exit 1
          }
          
          Write-Host "Tailscale found at: $tailscalePath"
          
          # Start Tailscale with authkey
          Write-Host "Starting Tailscale connection..."
          $authKey = "${{ secrets.TAILSCALE_AUTH_KEY }}"
          
          if ([string]::IsNullOrEmpty($authKey)) {
              Write-Error "TAILSCALE_AUTH_KEY secret is not set. Please add it to GitHub Secrets."
              exit 1
          }
          
          Write-Host "Using Tailscale auth key (first 10 chars): $($authKey.Substring(0, [math]::Min(10, $authKey.Length)))..."
          
          # Run Tailscale up command
          & $tailscalePath up --authkey=$authKey --hostname=gh-runner-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset
          
          # Check if command succeeded
          if ($LASTEXITCODE -ne 0) {
              Write-Host "Tailscale up command failed with exit code: $LASTEXITCODE"
              Write-Host "Trying without reset flag..."
              & $tailscalePath up --authkey=$authKey --hostname=gh-runner-$env:GITHUB_RUN_ID
          }
          
          # Wait for Tailscale to assign an IP with timeout
          Write-Host "Waiting for Tailscale IP assignment..."
          $tsIP = $null
          $maxRetries = 30  # 30 retries * 5 seconds = 150 seconds max wait
          $retryCount = 0
          
          while (-not $tsIP -and $retryCount -lt $maxRetries) {
              try {
                  $tsIP = & $tailscalePath ip -4 2>$null
                  if (-not $tsIP) {
                      Write-Host "No IP yet... ($retryCount/$maxRetries)"
                      Start-Sleep -Seconds 5
                      $retryCount++
                  }
              } catch {
                  Write-Host "Error checking IP: $_"
                  Start-Sleep -Seconds 5
                  $retryCount++
              }
          }
          
          if (-not $tsIP) {
              Write-Host "⚠ Tailscale IP not assigned after $maxRetries attempts."
              Write-Host "Checking Tailscale status..."
              & $tailscalePath status
              
              Write-Host "Trying to get any IP (v4 or v6)..."
              $tsIP = & $tailscalePath ip 2>$null
              
              if (-not $tsIP) {
                  Write-Host "⚠ Continuing without Tailscale IP - RDP may not be accessible"
                  echo "TAILSCALE_IP=NOT_ASSIGNED" >> $env:GITHUB_ENV
              } else {
                  echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
                  Write-Host "Tailscale IP (any): $tsIP"
              }
          } else {
              echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
              Write-Host "✓ Tailscale IPv4: $tsIP"
          }
          
          # Display Tailscale status for debugging
          Write-Host "Tailscale status:"
          & $tailscalePath status

      - name: Verify RDP Accessibility (Optional)
        run: |
          Write-Host "Checking RDP connectivity..."
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          
          if ($env:TAILSCALE_IP -eq "NOT_ASSIGNED") {
              Write-Host "⚠ Skipping RDP connectivity test - Tailscale IP not assigned"
              Write-Host "You may need to manually check Tailscale connection after RDP login"
          } else {
              # Test connectivity using Test-NetConnection
              $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue -ErrorAction SilentlyContinue
              if ($testResult.TcpTestSucceeded) {
                  Write-Host "✓ TCP connection to RDP port 3389 successful!"
              } else {
                  Write-Host "⚠ TCP connection to RDP port 3389 failed or timed out"
                  Write-Host "This may be normal if Windows Firewall is blocking or Tailscale is still connecting"
                  Write-Host "You can still try to connect via RDP"
              }
          }

      - name: Install Automa Chrome Extension
        run: |
          Write-Host "Creating Automa extension installation files..."
          
          # Create batch file
          $batchLines = @(
            '@echo off',
            'echo ============================================',
            'echo AUTOMA CHROME EXTENSION INSTALLATION',
            'echo ============================================',
            'echo.',
            'echo 1. Open Chrome',
            'echo 2. Visit: https://chrome.google.com/webstore/detail/automa/infppggnoaenmfagbfknfkancpbljcca',
            'echo 3. Click "Add to Chrome"',
            'echo.',
            'pause'
          )
          
          $batchPath = "C:\Users\Public\Desktop\Install_Automa.bat"
          $batchLines -join "`r`n" | Out-File -FilePath $batchPath -Encoding ASCII
          
          # Create URL shortcut
          $urlLines = @(
            '[InternetShortcut]',
            'URL=https://chrome.google.com/webstore/detail/automa/infppggnoaenmfagbfknfkancpbljcca'
          )
          
          $urlPath = "C:\Users\Public\Desktop\Install Automa.url"
          $urlLines -join "`r`n" | Out-File -FilePath $urlPath -Encoding ASCII
          
          Write-Host "✓ Created Automa installation files on desktop"

      - name: Create Instagram Auto Account Creator
        run: |
          Write-Host "Creating Instagram automation tool..."
          
          # Create batch file
          $batchLines = @(
            '@echo off',
            'echo ============================================',
            'echo INSTAGRAM ACCOUNT CREATION TOOL',
            'echo ============================================',
            'echo.',
            'echo Opening Instagram signup and temp email services...',
            'echo.',
            'start chrome --new-window "https://www.instagram.com/accounts/emailsignup/"',
            'timeout /t 3 /nobreak >nul',
            'start chrome --new-tab "https://temp-mail.org/"',
            'timeout /t 2 /nobreak >nul',
            'start chrome --new-tab "https://10minutemail.com/"',
            'echo.',
            'echo Chrome windows opened with:',
            'echo 1. Instagram signup',
            'echo 2. Temp-mail.org',
            'echo 3. 10MinuteMail',
            'echo.',
            'pause'
          )
          
          $batchPath = "C:\Users\Public\Desktop\Instagram_Tool.bat"
          $batchLines -join "`r`n" | Out-File -FilePath $batchPath -Encoding ASCII
          
          Write-Host "✓ Created Instagram tool on desktop"

      - name: Maintain Connection
        run: |
          Write-Host "`n=== RDP ACCESS INFORMATION ==="
          Write-Host "Username: MICKEY"
          Write-Host "Password: $(echo $env:RDP_CREDS)"
          
          if ($env:TAILSCALE_IP -ne "NOT_ASSIGNED") {
              Write-Host "Tailscale IP: $env:TAILSCALE_IP"
              Write-Host "Connect via: Remote Desktop -> $env:TAILSCALE_IP"
          } else {
              Write-Host "⚠ Tailscale IP: NOT ASSIGNED"
              Write-Host "After RDP login, check Tailscale icon in system tray"
              Write-Host "or run: tailscale status in Command Prompt"
          }
          
          Write-Host "===============================`n"
          
          Write-Host "DESKTO TOOLS:"
          Write-Host "1. Install_Automa.bat - Chrome extension"
          Write-Host "2. Instagram_Tool.bat - Account creator"
          Write-Host ""
          Write-Host "RDP session active. Cancel workflow when done."
          
          # Keep active
          while ($true) {
              Write-Host "[$(Get-Date)] RDP Active"
              Start-Sleep -Seconds 300
          }
