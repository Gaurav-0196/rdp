name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure Core RDP Settings
        run: |
          # Enable Remote Desktop and disable Network Level Authentication (if needed)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "SecurityLayer" -Value 0 -Force

          # Remove any existing rule with the same name to avoid duplication
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          
          # For testing, allow any incoming connection on port 3389
          netsh advfirewall firewall add rule name="RDP-Tailscale" `
            dir=in action=allow protocol=TCP localport=3389

          # (Optional) Restart the Remote Desktop service to ensure changes take effect
          Restart-Service -Name TermService -Force

      - name: Create RDP User
        run: |
          Write-Host "Creating RDP user..."
          
          # FIRST, disable password complexity using a simple command
          net accounts /MINPWLEN:1
          
          # Use a password that definitely meets requirements
          $password = "P@ssw0rd123!"
          
          # Create user using cmd.exe to avoid PowerShell restrictions
          cmd.exe /c "net user MICKEY $password /add /Y /expires:never"
          cmd.exe /c "net localgroup administrators MICKEY /add"
          cmd.exe /c "net localgroup `"Remote Desktop Users`" MICKEY /add"
          
          # Verify the user was created
          $userCheck = cmd.exe /c "net user MICKEY"
          if ($userCheck -like "*User name*MICKEY*") {
              echo "RDP_CREDS=User: MICKEY | Password: $password" >> $env:GITHUB_ENV
              Write-Host "✓ User created successfully!"
              Write-Host "Username: MICKEY"
              Write-Host "Password: $password"
          } else {
              Write-Error "User creation failed"
              exit 1
          }

      - name: Set Simple Wallpaper
        run: |
          Write-Host "Creating wallpaper tools..."
          
          # Create a simple batch file to change wallpaper
          $batchLines = @(
            '@echo off',
            'echo WALLPAPER CHANGER',
            'echo ==================',
            'echo.',
            'echo This opens wallpaper settings.',
            'echo You can choose any wallpaper you like.',
            'echo.',
            'control /name Microsoft.Personalization /page pageWallpaper',
            'echo.',
            'echo Settings opened.',
            'echo Choose your wallpaper and close when done.',
            'pause'
          )
          
          $batchPath = "C:\Users\Public\Desktop\Change_Wallpaper.bat"
          $batchLines -join "`r`n" | Out-File -FilePath $batchPath -Encoding ASCII
          
          Write-Host "✓ Wallpaper changer created on desktop"

      - name: Install Tailscale
        run: |
          Write-Host "Installing Tailscale..."
          
          # Download Tailscale installer
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          
          # Install Tailscale
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          
          # Clean up
          Remove-Item $installerPath -Force
          Write-Host "✓ Tailscale installed"
          
          Start-Sleep -Seconds 5

      - name: Establish Tailscale Connection
        run: |
          Write-Host "Setting up Tailscale connection..."
          
          $tailscalePath = "${env:ProgramFiles}\Tailscale\tailscale.exe"
          
          if (Test-Path $tailscalePath) {
              $authKey = "${{ secrets.TAILSCALE_AUTH_KEY }}"
              
              if ($authKey -and $authKey -ne "") {
                  & $tailscalePath up --authkey=$authKey --hostname=gh-runner-$env:GITHUB_RUN_ID
                  Start-Sleep -Seconds 5
                  $tsIP = & $tailscalePath ip -4
                  
                  if ($tsIP) {
                      echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
                      Write-Host "✓ Tailscale IP: $tsIP"
                  } else {
                      echo "TAILSCALE_IP=CONNECTING" >> $env:GITHUB_ENV
                      Write-Host "Tailscale connecting..."
                  }
              } else {
                  echo "TAILSCALE_IP=NO_KEY" >> $env:GITHUB_ENV
                  Write-Host "⚠ No Tailscale auth key provided"
              }
          } else {
              echo "TAILSCALE_IP=NOT_INSTALLED" >> $env:GITHUB_ENV
              Write-Host "⚠ Tailscale not installed"
          }

      - name: Install Automa Chrome Extension
        run: |
          Write-Host "Creating Automa extension installer..."
          
          # Create simple batch file
          $batchLines = @(
            '@echo off',
            'echo AUTOMA CHROME EXTENSION',
            'echo =========================',
            'echo.',
            'echo 1. Open Chrome',
            'echo 2. Visit this link:',
            'echo    https://chrome.google.com/webstore/detail/automa/infppggnoaenmfagbfknfkancpbljcca',
            'echo 3. Click "Add to Chrome"',
            'echo.',
            'pause'
          )
          
          $batchPath = "C:\Users\Public\Desktop\Install_Automa.bat"
          $batchLines -join "`r`n" | Out-File -FilePath $batchPath -Encoding ASCII
          
          # Create URL shortcut
          $urlLines = @(
            '[InternetShortcut]',
            'URL=https://chrome.google.com/webstore/detail/automa/infppggnoaenmfagbfknfkancpbljcca'
          )
          
          $urlPath = "C:\Users\Public\Desktop\Automa_Extension.url"
          $urlLines -join "`r`n" | Out-File -FilePath $urlPath -Encoding ASCII
          
          Write-Host "✓ Automa installer created on desktop"

      - name: Create Useful Shortcuts
        run: |
          Write-Host "Creating desktop shortcuts..."
          
          # Create Chrome shortcut if exists
          $chromePaths = @(
              "${env:ProgramFiles}\Google\Chrome\Application\chrome.exe",
              "${env:ProgramFiles(x86)}\Google\Chrome\Application\chrome.exe"
          )
          
          foreach ($path in $chromePaths) {
              if (Test-Path $path) {
                  $shell = New-Object -ComObject WScript.Shell
                  $shortcut = $shell.CreateShortcut("C:\Users\Public\Desktop\Chrome.lnk")
                  $shortcut.TargetPath = $path
                  $shortcut.Save()
                  Write-Host "✓ Chrome shortcut created"
                  break
              }
          }
          
          # Create basic shortcuts
          $shell = New-Object -ComObject WScript.Shell
          
          # Notepad
          $shortcut = $shell.CreateShortcut("C:\Users\Public\Desktop\Notepad.lnk")
          $shortcut.TargetPath = "notepad.exe"
          $shortcut.Save()
          
          # Command Prompt
          $shortcut = $shell.CreateShortcut("C:\Users\Public\Desktop\CMD.lnk")
          $shortcut.TargetPath = "cmd.exe"
          $shortcut.Save()
          
          # File Explorer
          $shortcut = $shell.CreateShortcut("C:\Users\Public\Desktop\File Explorer.lnk")
          $shortcut.TargetPath = "explorer.exe"
          $shortcut.Save()
          
          Write-Host "✓ Desktop shortcuts created"

      - name: Maintain Connection
        run: |
          Write-Host "`n=== RDP ACCESS INFORMATION ==="
          Write-Host "Username: MICKEY"
          Write-Host "Password: $(echo $env:RDP_CREDS)"
          
          if ($env:TAILSCALE_IP -and $env:TAILSCALE_IP -notin @("NO_KEY", "NOT_INSTALLED", "CONNECTING")) {
              Write-Host "Tailscale IP: $env:TAILSCALE_IP"
              Write-Host "Connect to: $env:TAILSCALE_IP"
          } else {
              Write-Host "Tailscale Status: $env:TAILSCALE_IP"
          }
          
          Write-Host "===============================`n"

          # Keep active
          while ($true) {
              Write-Host "[$(Get-Date)] RDP Active"
              Start-Sleep -Seconds 300
          }
